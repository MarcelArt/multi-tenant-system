// This file is auto generated by polygo
package repositories

import (
	"github.com/MarcelArt/multi-tenant-system/models"
	"github.com/gofiber/fiber/v2"
	"github.com/morkid/paginate"
	"gorm.io/gorm"
)

const userPageQuery = `
	select 
		id,
		username, 
		email
	from users
	where deleted_at is null
`

type IUserRepo interface {
	IBaseCrudRepo[models.User, models.UserDTO, models.UserPage]
	GetByUsernameOrEmail(username string) (models.UserDTO, error)
	GetOrgPermissions(id any, orgID any) ([]string, error)
	GetPermissions(id any) ([]models.OrganizationPermissionClaims, error)
	GetByOrgIDWithRoles(orgID any, c *fiber.Ctx) paginate.Page
}

type UserRepo struct {
	BaseCrudRepo[models.User, models.UserDTO, models.UserPage]
}

func NewUserRepo(db *gorm.DB) *UserRepo {
	return &UserRepo{
		BaseCrudRepo: BaseCrudRepo[models.User, models.UserDTO, models.UserPage]{
			db:        db,
			pageQuery: userPageQuery,
		},
	}
}

func (r *UserRepo) GetByUsernameOrEmail(username string) (models.UserDTO, error) {
	var user models.UserDTO
	err := r.db.Where("(username = ? OR email = ?)", username, username).First(&user).Error
	return user, err
}

func (r *UserRepo) GetOrgPermissions(id any, orgID any) ([]string, error) {
	var permissions []string
	query := `
		select
			distinct rp."permission" as permissions
		from roles r
		left join role_permissions rp on r.id = rp.role_id 
		left join user_roles ur on r.id = ur.role_id
		where r.organization_id = ?
		and ur.user_id = ?
		and rp.deleted_at isnull
		and ur.deleted_at isnull
	`

	err := r.db.Raw(query, orgID, id).Pluck("permissions", &permissions).Error
	return permissions, err
}

func (r *UserRepo) GetPermissions(id any) ([]models.OrganizationPermissionClaims, error) {
	var orgPermissions []models.OrganizationPermissionClaims
	query := `
		select
			r.organization_id as org_id,
			string_agg(rp."permission", ';') as permissions
		from roles r
		left join role_permissions rp on r.id = rp.role_id 
		left join user_roles ur on r.id = ur.role_id
		where ur.user_id = ?
		and rp.deleted_at isnull
		and ur.deleted_at isnull
		group by r.organization_id 
	`

	err := r.db.Raw(query, id).Scan(&orgPermissions).Error
	return orgPermissions, err
}

func (r *UserRepo) GetByOrgIDWithRoles(orgID any, c *fiber.Ctx) paginate.Page {
	pg := paginate.New()

	query := `
		select 
				u.id id,
				u.username username, 
				u.email email,
				uo.organization_id organization_id,
				string_agg(r.value, ';') roles,
				string_agg(r.id::text, ';') role_ids
		from users u
		left join user_roles ur on u.id = ur.user_id and ur.deleted_at isnull
		left join roles r on ur.role_id = r.id and r.deleted_at isnull
		left join user_organizations uo on u.id = uo.user_id and uo.deleted_at isnull
		where u.deleted_at is null
		and uo.organization_id = ?
		group by
				u.id,
				u.username,
				u.email,
				uo.organization_id
	`
	stmt := r.db.Raw(query, orgID)

	var dest []models.UserWithRoles
	page := pg.With(stmt).Request(c.Request()).Response(&dest)

	return page
}
